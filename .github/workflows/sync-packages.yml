name: Sync OpenWrt Packages

on:
  # 定时执行，每天凌晨2点运行
  schedule:
    - cron: '0 2 * * *'
  # 手动触发
  workflow_dispatch:
  # 当仓库有推送时触发
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  sync-packages:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install GitPython
    
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
    
    - name: Run sync script
      run: |
        # 创建同步脚本
        echo '#!/usr/bin/env python3' > sync_packages.py
        echo 'import os' >> sync_packages.py
        echo 'import shutil' >> sync_packages.py
        echo 'import git' >> sync_packages.py
        echo 'import hashlib' >> sync_packages.py
        echo 'import argparse' >> sync_packages.py
        echo 'from pathlib import Path' >> sync_packages.py
        echo '' >> sync_packages.py
        echo 'SOURCE_REPOS = {' >> sync_packages.py
        echo '    "small-package": {' >> sync_packages.py
        echo '        "url": "https://github.com/kenzok8/small-package.git"' >> sync_packages.py
        echo '    },' >> sync_packages.py
        echo '    "helloworld": {' >> sync_packages.py
        echo '        "url": "https://github.com/fw876/helloworld.git"' >> sync_packages.py
        echo '    },' >> sync_packages.py
        echo '    "modem_feeds": {' >> sync_packages.py
        echo '        "url": "https://github.com/FUjr/modem_feeds.git"' >> sync_packages.py
        echo '    }' >> sync_packages.py
        echo '}' >> sync_packages.py
        echo '' >> sync_packages.py
        echo 'class PackageSyncer:' >> sync_packages.py
        echo '    def __init__(self, work_dir, output_dir):' >> sync_packages.py
        echo '        self.work_dir = Path(work_dir)' >> sync_packages.py
        echo '        self.output_dir = Path(output_dir)' >> sync_packages.py
        echo '        self.package_versions = {}' >> sync_packages.py
        echo '        self.all_packages = []' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        self.work_dir.mkdir(parents=True, exist_ok=True)' >> sync_packages.py
        echo '        self.output_dir.mkdir(parents=True, exist_ok=True)' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        self._scan_existing_packages()' >> sync_packages.py
        echo '' >> sync_packages.py
        echo '    def _scan_existing_packages(self):' >> sync_packages.py
        echo '        print("扫描仓库中已有的软件包...")' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        keep_items = [".git", ".github", ".gitignore", "README.md", "sync_packages.py", "temp_repos"]' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        for item in self.output_dir.iterdir():' >> sync_packages.py
        echo '            if item.name in keep_items:' >> sync_packages.py
        echo '                continue' >> sync_packages.py
        echo '                ' >> sync_packages.py
        echo '            if item.is_dir():' >> sync_packages.py
        echo '                makefile_path = item / "Makefile"' >> sync_packages.py
        echo '                if makefile_path.exists():' >> sync_packages.py
        echo '                    pkg_info = self._parse_makefile_version(makefile_path)' >> sync_packages.py
        echo '                    pkg_name = pkg_info["PKG_NAME"] or item.name' >> sync_packages.py
        echo '                    version = pkg_info["PKG_VERSION"]' >> sync_packages.py
        echo '                    release = pkg_info["PKG_RELEASE"]' >> sync_packages.py
        echo '                    ' >> sync_packages.py
        echo '                    # 使用pkg_name作为键存储已有的软件包版本信息' >> sync_packages.py
        echo '                    self.package_versions[pkg_name] = (version, release)' >> sync_packages.py
        echo '                    print(f"发现已有软件包: {item.name} (pkg_name: {pkg_name}, 版本: {version}-{release})")' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        print(f"共扫描到 {len(self.package_versions)} 个已存在的软件包")' >> sync_packages.py
        echo '' >> sync_packages.py
        echo '    def _compare_versions(self, ver1, ver2):' >> sync_packages.py
        echo '        try:' >> sync_packages.py
        echo '            def normalize(v):' >> sync_packages.py
        echo '                v = str(v)' >> sync_packages.py
        echo '                if "$" in v or "(" in v or ")" in v or "call" in v or "subst" in v:' >> sync_packages.py
        echo '                    return [v]' >> sync_packages.py
        echo '                parts = []' >> sync_packages.py
        echo '                for part in v.split("."):' >> sync_packages.py
        echo '                    try:' >> sync_packages.py
        echo '                        parts.append(int(part))' >> sync_packages.py
        echo '                    except ValueError:' >> sync_packages.py
        echo '                        parts.append(part)' >> sync_packages.py
        echo '                return parts' >> sync_packages.py
        echo '            ' >> sync_packages.py
        echo '            v1 = normalize(ver1)' >> sync_packages.py
        echo '            v2 = normalize(ver2)' >> sync_packages.py
        echo '            ' >> sync_packages.py
        echo '            for a, b in zip(v1, v2):' >> sync_packages.py
        echo '                if isinstance(a, int) and isinstance(b, int):' >> sync_packages.py
        echo '                    if a > b:' >> sync_packages.py
        echo '                        return 1' >> sync_packages.py
        echo '                    elif a < b:' >> sync_packages.py
        echo '                        return -1' >> sync_packages.py
        echo '                elif isinstance(a, str) and isinstance(b, str):' >> sync_packages.py
        echo '                    if a > b:' >> sync_packages.py
        echo '                        return 1' >> sync_packages.py
        echo '                    elif a < b:' >> sync_packages.py
        echo '                        return -1' >> sync_packages.py
        echo '                else:' >> sync_packages.py
        echo '                    if str(a) > str(b):' >> sync_packages.py
        echo '                        return 1' >> sync_packages.py
        echo '                    elif str(a) < str(b):' >> sync_packages.py
        echo '                        return -1' >> sync_packages.py
        echo '            ' >> sync_packages.py
        echo '            if len(v1) > len(v2):' >> sync_packages.py
        echo '                return 1' >> sync_packages.py
        echo '            elif len(v1) < len(v2):' >> sync_packages.py
        echo '                return -1' >> sync_packages.py
        echo '            else:' >> sync_packages.py
        echo '                return 0' >> sync_packages.py
        echo '        except Exception as e:' >> sync_packages.py
        echo '            print(f"版本比较失败: {ver1} vs {ver2}, 错误: {e}")' >> sync_packages.py
        echo '            return -2' >> sync_packages.py
        echo '' >> sync_packages.py
        echo '    def _parse_makefile_version(self, makefile_path):' >> sync_packages.py
        echo '        result = {' >> sync_packages.py
        echo '            "PKG_NAME": None,' >> sync_packages.py
        echo '            "PKG_VERSION": "0",' >> sync_packages.py
        echo '            "PKG_RELEASE": "0"' >> sync_packages.py
        echo '        }' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        try:' >> sync_packages.py
        echo '            with open(makefile_path, "r", encoding="utf-8") as f:' >> sync_packages.py
        echo '                for line in f:' >> sync_packages.py
        echo '                    line = line.strip()' >> sync_packages.py
        echo '                    if line.startswith("PKG_NAME:="):' >> sync_packages.py
        echo '                        result["PKG_NAME"] = line.split(":=")[1].strip()' >> sync_packages.py
        echo '                    elif line.startswith("PKG_VERSION:="):' >> sync_packages.py
        echo '                        result["PKG_VERSION"] = line.split(":=")[1].strip()' >> sync_packages.py
        echo '                    elif line.startswith("PKG_RELEASE:="):' >> sync_packages.py
        echo '                        result["PKG_RELEASE"] = line.split(":=")[1].strip()' >> sync_packages.py
        echo '        except Exception as e:' >> sync_packages.py
        echo '            print(f"解析 Makefile {makefile_path} 时出错: {e}")' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        return result' >> sync_packages.py
        echo '' >> sync_packages.py

        echo '    def _clone_or_pull_repo(self, repo_name, repo_url, branch=None):' >> sync_packages.py
        echo '        repo_path = self.work_dir / repo_name' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        if repo_path.exists():' >> sync_packages.py
        echo '            print(f"更新仓库: {repo_name}")' >> sync_packages.py
        echo '            repo = git.Repo(repo_path)' >> sync_packages.py
        echo '            origin = repo.remotes.origin' >> sync_packages.py
        echo '            if branch:' >> sync_packages.py
        echo '                origin.pull(branch)' >> sync_packages.py
        echo '            else:' >> sync_packages.py
        echo '                origin.pull()' >> sync_packages.py
        echo '        else:' >> sync_packages.py
        echo '            print(f"克隆仓库: {repo_name}")' >> sync_packages.py
        echo '            clone_options = {' >> sync_packages.py
        echo '                "depth": 1,' >> sync_packages.py
        echo '                "single_branch": True' >> sync_packages.py
        echo '            }' >> sync_packages.py
        echo '            if branch:' >> sync_packages.py
        echo '                clone_options["branch"] = branch' >> sync_packages.py
        echo '            ' >> sync_packages.py
        echo '            repo = git.Repo.clone_from(repo_url, repo_path, **clone_options)' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        return repo_path' >> sync_packages.py
        echo '' >> sync_packages.py
        echo '    def _is_valid_package_dir(self, dir_path):' >> sync_packages.py
        echo '        dir_path = Path(dir_path)' >> sync_packages.py
        echo '        return (dir_path / "Makefile").exists()' >> sync_packages.py
        echo '' >> sync_packages.py
        echo '    def sync_package(self, package_path, repo_name):' >> sync_packages.py
        echo '        package_name = package_path.name' >> sync_packages.py
        echo '        makefile_path = package_path / "Makefile"' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        pkg_info = self._parse_makefile_version(makefile_path)' >> sync_packages.py
        echo '        pkg_name = pkg_info["PKG_NAME"] or package_name' >> sync_packages.py
        echo '        version = pkg_info["PKG_VERSION"]' >> sync_packages.py
        echo '        release = pkg_info["PKG_RELEASE"]' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        # 收集软件包信息，不直接复制' >> sync_packages.py
        echo '        self.all_packages.append({' >> sync_packages.py
        echo '            "name": package_name,' >> sync_packages.py
        echo '            "pkg_name": pkg_name,' >> sync_packages.py
        echo '            "version": version,' >> sync_packages.py
        echo '            "release": release,' >> sync_packages.py
        echo '            "path": package_path,' >> sync_packages.py
        echo '            "repo_name": repo_name' >> sync_packages.py
        echo '        })' >> sync_packages.py
        echo '' >> sync_packages.py
        echo '    def _find_all_package_dirs(self, root_path):' >> sync_packages.py
        echo '        package_dirs = []' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        for item in root_path.iterdir():' >> sync_packages.py
        echo '            if item.is_dir():' >> sync_packages.py
        echo '                if item.name.startswith(".") or item.name == "temp" or item.name == "tmp":' >> sync_packages.py
        echo '                    continue' >> sync_packages.py
        echo '                    ' >> sync_packages.py
        echo '                if self._is_valid_package_dir(item):' >> sync_packages.py
        echo '                    package_dirs.append(item)' >> sync_packages.py
        echo '                else:' >> sync_packages.py
        echo '                    sub_packages = self._find_all_package_dirs(item)' >> sync_packages.py
        echo '                    package_dirs.extend(sub_packages)' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        return package_dirs' >> sync_packages.py
        echo '' >> sync_packages.py
        echo '    def sync_from_repo(self, repo_name, repo_config):' >> sync_packages.py
        echo '        repo_path = self._clone_or_pull_repo(' >> sync_packages.py
        echo '            repo_name, ' >> sync_packages.py
        echo '            repo_config["url"], ' >> sync_packages.py
        echo '            repo_config.get("branch")' >> sync_packages.py
        echo '        )' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        package_dirs = self._find_all_package_dirs(repo_path)' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        for package_path in package_dirs:' >> sync_packages.py
        echo '            self.sync_package(package_path, repo_name)' >> sync_packages.py
        echo '' >> sync_packages.py
        echo '    def _process_all_packages(self):' >> sync_packages.py
        echo '        """处理所有收集到的软件包，进行去重和版本比较，然后统一复制"""' >> sync_packages.py
        echo '        print(f"共收集到 {len(self.all_packages)} 个软件包，开始统一处理...")' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        # 去重并保留每个包名的最新版本' >> sync_packages.py
        echo '        best_packages = {}' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        for pkg in self.all_packages:' >> sync_packages.py
        echo '            pkg_name = pkg["pkg_name"]' >> sync_packages.py
        echo '            version = pkg["version"]' >> sync_packages.py
        echo '            release = pkg["release"]' >> sync_packages.py
        echo '            ' >> sync_packages.py
        echo '            # 检查是否已存在该包名' >> sync_packages.py
        echo '            if pkg_name not in best_packages:' >> sync_packages.py
        echo '                # 如果不存在，直接添加' >> sync_packages.py
        echo '                best_packages[pkg_name] = pkg' >> sync_packages.py
        echo '            else:' >> sync_packages.py
        echo '                # 如果已存在，比较版本' >> sync_packages.py
        echo '                existing = best_packages[pkg_name]' >> sync_packages.py
        echo '                existing_version = existing["version"]' >> sync_packages.py
        echo '                existing_release = existing["release"]' >> sync_packages.py
        echo '                ' >> sync_packages.py
        echo '                # 比较主版本' >> sync_packages.py
        echo '                ver_compare = self._compare_versions(version, existing_version)' >> sync_packages.py
        echo '                ' >> sync_packages.py
        echo '                # 版本比较失败，保留已有的包' >> sync_packages.py
        echo '                if ver_compare == -2:' >> sync_packages.py
        echo '                    continue' >> sync_packages.py
        echo '                ' >> sync_packages.py
        echo '                # 如果当前版本更高，更新' >> sync_packages.py
        echo '                if ver_compare > 0:' >> sync_packages.py
        echo '                    best_packages[pkg_name] = pkg' >> sync_packages.py
        echo '                elif ver_compare == 0:' >> sync_packages.py
        echo '                    # 主版本相同，比较 release 版本' >> sync_packages.py
        echo '                    rel_compare = self._compare_versions(release, existing_release)' >> sync_packages.py
        echo '                    # release 版本比较失败，保留已有的包' >> sync_packages.py
        echo '                    if rel_compare == -2:' >> sync_packages.py
        echo '                        continue' >> sync_packages.py
        echo '                    # 如果当前 release 版本更高，更新' >> sync_packages.py
        echo '                    if rel_compare > 0:' >> sync_packages.py
        echo '                        best_packages[pkg_name] = pkg' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        print(f"去重后得到 {len(best_packages)} 个软件包")' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        # 复制最佳版本的软件包到输出目录' >> sync_packages.py
        echo '        for pkg in best_packages.values():' >> sync_packages.py
        echo '            package_path = pkg["path"]' >> sync_packages.py
        echo '            package_name = pkg["name"]' >> sync_packages.py
        echo '            repo_name = pkg["repo_name"]' >> sync_packages.py
        echo '            version = pkg["version"]' >> sync_packages.py
        echo '            release = pkg["release"]' >> sync_packages.py
        echo '            ' >> sync_packages.py
        echo '            # 检查是否需要更新已存在的包' >> sync_packages.py
        echo '            update_needed = False' >> sync_packages.py
        echo '            ' >> sync_packages.py
        echo '            # 使用pkg_name进行对比，确保同一个软件包即使目录名不同也能正确比较' >> sync_packages.py
        echo '            if pkg_name in self.package_versions:' >> sync_packages.py
        echo '                existing_version, existing_release = self.package_versions[pkg_name]' >> sync_packages.py
        echo '                ver_compare = self._compare_versions(version, existing_version)' >> sync_packages.py
        echo '                ' >> sync_packages.py
        echo '                if ver_compare == -2:' >> sync_packages.py
        echo '                    print(f"版本比较失败，跳过软件包: {package_name} (来自 {repo_name})")' >> sync_packages.py
        echo '                    continue' >> sync_packages.py
        echo '                ' >> sync_packages.py
        echo '                if ver_compare > 0:' >> sync_packages.py
        echo '                    update_needed = True' >> sync_packages.py
        echo '                    print(f"更新软件包: {package_name} (来自 {repo_name})，版本 {existing_version} -> {version}")' >> sync_packages.py
        echo '                elif ver_compare == 0:' >> sync_packages.py
        echo '                    rel_compare = self._compare_versions(release, existing_release)' >> sync_packages.py
        echo '                    ' >> sync_packages.py
        echo '                    if rel_compare == -2:' >> sync_packages.py
        echo '                        print(f"Release 版本比较失败，跳过软件包: {package_name} (来自 {repo_name})")' >> sync_packages.py
        echo '                        continue' >> sync_packages.py
        echo '                    ' >> sync_packages.py
        echo '                    if rel_compare > 0:' >> sync_packages.py
        echo '                        update_needed = True' >> sync_packages.py
        echo '                        print(f"更新软件包: {package_name} (来自 {repo_name})，版本 {existing_version}-{existing_release} -> {version}-{release}")' >> sync_packages.py
        echo '                    else:' >> sync_packages.py
        echo '                        print(f"跳过版本更低的软件包: {package_name} (来自 {repo_name})")' >> sync_packages.py
        echo '                        continue' >> sync_packages.py
        echo '                else:' >> sync_packages.py
        echo '                    print(f"跳过版本更低的软件包: {package_name} (来自 {repo_name})")' >> sync_packages.py
        echo '                    continue' >> sync_packages.py
        echo '            else:' >> sync_packages.py
        echo '                update_needed = True' >> sync_packages.py
        echo '                print(f"同步新软件包: {package_name} (来自 {repo_name})，版本 {version}-{release}")' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '            if update_needed:' >> sync_packages.py
        echo '                # 复制软件包到输出目录' >> sync_packages.py
        echo '                dest_path = self.output_dir / package_name' >> sync_packages.py
        echo '                ' >> sync_packages.py
        echo '                # 如果目标目录已存在，先删除' >> sync_packages.py
        echo '                if dest_path.exists():' >> sync_packages.py
        echo '                    shutil.rmtree(dest_path)' >> sync_packages.py
        echo '                ' >> sync_packages.py
        echo '                # 复制软件包目录' >> sync_packages.py
        echo '                shutil.copytree(package_path, dest_path)' >> sync_packages.py
        echo '                ' >> sync_packages.py
        echo '                # 更新版本记录，使用pkg_name作为键' >> sync_packages.py
        echo '                self.package_versions[pkg_name] = (version, release)' >> sync_packages.py
        echo '                ' >> sync_packages.py
        echo '                # 添加源仓库信息文件' >> sync_packages.py
        echo '                with open(dest_path / ".sync_source", "w", encoding="utf-8") as f:' >> sync_packages.py
        echo '                    f.write(f"repo: {repo_name}\n")' >> sync_packages.py
        echo '                    f.write(f"package: {package_name}\n")' >> sync_packages.py
        echo '                    f.write(f"version: {version}\n")' >> sync_packages.py
        echo '                    f.write(f"release: {release}\n")' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '    def run_sync(self):' >> sync_packages.py
        echo '        print("开始同步 OpenWrt 软件包...")' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        # 第一步：从所有仓库收集软件包信息' >> sync_packages.py
        echo '        for repo_name, repo_config in SOURCE_REPOS.items():' >> sync_packages.py
        echo '            try:' >> sync_packages.py
        echo '                self.sync_from_repo(repo_name, repo_config)' >> sync_packages.py
        echo '            except Exception as e:' >> sync_packages.py
        echo '                print(f"同步仓库 {repo_name} 时出错: {e}")' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        # 第二步：统一处理所有收集到的软件包' >> sync_packages.py
        echo '        self._process_all_packages()' >> sync_packages.py
        echo '        ' >> sync_packages.py
        echo '        print(f"同步完成！最终得到 {len(self.package_versions)} 个软件包")' >> sync_packages.py
        echo '        print(f"同步结果存储在: {self.output_dir}")' >> sync_packages.py
        echo '' >> sync_packages.py
        echo 'def main():' >> sync_packages.py
        echo '    parser = argparse.ArgumentParser(description="OpenWrt 软件包同步脚本")' >> sync_packages.py
        echo '    parser.add_argument(' >> sync_packages.py
        echo '        "--work-dir", ' >> sync_packages.py
        echo '        default="./temp_repos", ' >> sync_packages.py
        echo '        help="临时工作目录，用于存储克隆的仓库"' >> sync_packages.py
        echo '    )' >> sync_packages.py
        echo '    parser.add_argument(' >> sync_packages.py
        echo '        "--output-dir", ' >> sync_packages.py
        echo '        default=".", ' >> sync_packages.py
        echo '        help="输出目录，用于存储同步后的软件包（默认当前目录）"' >> sync_packages.py
        echo '    )' >> sync_packages.py
        echo '    ' >> sync_packages.py
        echo '    args = parser.parse_args()' >> sync_packages.py
        echo '    ' >> sync_packages.py
        echo '    syncer = PackageSyncer(args.work_dir, args.output_dir)' >> sync_packages.py
        echo '    syncer.run_sync()' >> sync_packages.py
        echo '' >> sync_packages.py
        echo 'if __name__ == "__main__":' >> sync_packages.py
        echo '    main()' >> sync_packages.py
        
        # 运行同步脚本
        python sync_packages.py --work-dir ./temp_repos --output-dir .
        rm sync_packages.py
    
    - name: Check for changes
      id: check_changes
      run: |
        git status --porcelain
        if git status --porcelain | grep -q "";
        then
          echo "changes_detected=true" >> $GITHUB_OUTPUT
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        git add .
        git reset -- ./.gitignore
        git reset -- ./README.md
        git reset -- ./sync_packages.py
        git reset -- ./.github/
        git commit -m "Sync packages from source repositories $(date -u +'%Y-%m-%d %H:%M:%S')"
        git push origin main
    
    - name: Clean up
      run: |
        rm -rf ./temp_repos
